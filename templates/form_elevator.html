{% if pdf_mode %}
<style>
@font-face {
    font-family: 'Roboto';
    src: url('/static/fonts/Roboto-Regular.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}
body, input, textarea, select, button {
    font-family: 'Roboto', Arial, Helvetica, sans-serif;
}
input, textarea, select, button, .signature-doodle-btn, script { display: none !important; }
.question-options, .question-comments { display: block !important; }
</style>

<!-- Show approved status at top of PDF -->
{% if approved %}
<div style="background: #28a745; color: white; padding: 12px; text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 20px; border-radius: 8px;">
    ✓ APPROVED
</div>
{% endif %}
{% endif %}

<!-- For each input, textarea, or radio, display the value as plain text in pdf_mode -->
{% macro show_value(name, default='') %}
    {% if pdf_mode %}
        <span style="font-weight:normal;">{{ fields[name] if fields and name in fields else default }}</span>
    {% else %}
        {{ caller() }}
    {% endif %}
{% endmacro %}

<!-- Example usage for a text input: -->
<!--
{% call show_value('offer_number') %}
    <input type="text" name="offer_number" required>
{% endcall %}
-->



<!-- Offer / Order Review Checklist Section -->
<div class="section-title" style="color: #d32f2f; font-weight: bold;">Offer / Order Review Checklist</div>
<div style="color: #666; margin-bottom: 20px;">Global Master</div>

<div class="offer-review-grid">
    <div class="offer-review-item">
    <div class="question-label">Offer N°:</div>
        {% call show_value('offer_number') %}
        <input type="text" name="offer_number" required>
        {% endcall %}
</div>
    <div class="offer-review-item">
    <div class="question-label">Project Name:</div>
        {% call show_value('project_name') %}
        <input type="text" name="project_name" required>
        {% endcall %}
</div>
    <div class="offer-review-item">
    <div class="question-label">Com. N°:</div>
        {% call show_value('com_number') %}
        <input type="text" name="com_number" required>
        {% endcall %}
</div>
    <div class="offer-review-item">
    <div class="question-label">Customer:</div>
        {% call show_value('customer_name') %}
        <input type="text" name="customer_name" required>
        {% endcall %}
    </div>
    <div class="offer-review-item">
        <div class="question-label">Customer Contact:</div>
        {% call show_value('customer_contact') %}
        <input type="text" name="customer_contact" required>
        {% endcall %}
    </div>
</div>

<style>
.offer-review-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px 32px;
    margin-bottom: 24px;
}
.offer-review-item {
    display: flex;
    flex-direction: column;
    font-size: 17px;
    font-family: 'Roboto', Arial, sans-serif;
}
.offer-review-item input[type="text"] {
    font-size: 15px;
    padding: 6px 10px;
    border: 1px solid #dadce0;
    border-radius: 4px;
    background: #f1f3f4;
    margin-top: 6px;
    width: 90%;
    max-width: 260px;
    box-sizing: border-box;
}
@media (max-width: 700px) {
    .offer-review-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<!-- Project Qualification Criteria Section -->
<div class="section-title" style="margin-top: 10px;">Project Qualification Criteria</div>
<div class="qualification-box">
    {% for label, name in [
        ('Projects priced more than 1 million SAR', 'qual_1m_sar'),
        ('Projects located in remote areas', 'qual_remote'),
        ('Non-standard jobs', 'qual_nonstandard'),
        ('CUST product lines', 'qual_cust'),
        ('MOD projects', 'qual_mod')
    ] %}
        <label class="qualification-item">
            {% if pdf_mode %}
                <span style="font-size:18px;">{{ '✔' if fields and (name in fields) else '✗' }}</span>
                <span style="margin-left:8px;">{{ label }}</span>
            {% else %}
                <input type="checkbox" name="{{ name }}" {% if fields and (name in fields) %}checked{% endif %}> {{ label }}
            {% endif %}
        </label>
    {% endfor %}
</div>

<style>
.qualification-box {
    border: 1px solid #dadce0;
    border-radius: 8px;
    background: #f8f9fa;
    padding: 18px 24px 10px 24px;
    margin-bottom: 28px;
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-width: 520px;
}
.qualification-item {
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'Roboto', Arial, sans-serif;
    color: #111;
}
.qualification-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #b00;
    margin-right: 8px;
}
</style>

<!-- Elevator Form Sections -->
<div class="section-title">Contact Information</div>
<div class="question-row">
    <div class="question-label">Salesman Email:</div>
    {% call show_value('salesman_email') %}
    <input type="email" name="salesman_email" required style="flex:3;">
    {% endcall %}
</div>
<div class="question-row">
    <div class="question-label">Project Manager Email:</div>
    {% call show_value('pm_email') %}
    <input type="email" name="pm_email" required style="flex:3;">
    {% endcall %}
</div>
<div class="section-title">Project Data</div>
<div class="question-row">
    <div class="question-label">Product line:</div>
    {% call show_value('product_line') %}
    <input type="text" name="product_line" required style="flex:3;">
    {% endcall %}
</div>
<div class="question-row">
    <div class="question-label">Process type:</div>
    {% call show_value('process_type') %}
    <input type="text" name="process_type" required style="flex:3;">
    {% endcall %}
</div>

<div class="section-title">Customer Requirements</div>
{% set elevator_questions = [
    ('Unit used as construction elevator?', 'unit_construction_elevator', 'Charges approved by FF?'),
    ('Working time restrictions?', 'working_time_restrictions', ''),
    ('Special designated use of the elevator? (High traffic, Attica, Heavy loading, ...)', 'special_designated_use', ''),
    ('Special technical requirements? (Atmospheric exposure, steel structure, ...)', 'special_technical_requirements', ''),
    ('Installation dates, handover defined and achievable, Programme agreed with customer (lead time, resources, ...)?', 'installation_dates', 'Hand over Date agreed: ..........'),
    ('Site Office required / Priced?', 'site_office_required', ''),
    ('Special customer relation and/or installation relevant benefits communicated?', 'special_customer_relation', ''),
    ('Special work conditions (Temperature, dust, humidity, drilling restrictions, night shift, ...)?', 'special_work_conditions', '')
] %}
{% for label, name, comment_hint in elevator_questions %}
<div class="question-row">
    <div class="question-label">{{ label }}</div>
    <div class="question-options">
        {% if pdf_mode %}
            <span style="font-weight:normal;">{{ fields[name + '_yn'] if fields and (name + '_yn') in fields else 'N/A' }}</span>
        {% else %}
            <label><input type="radio" name="{{ name }}_yn" value="Yes" required {% if fields and fields[name + '_yn']=='Yes' %}checked{% endif %}> Yes</label>
            <label><input type="radio" name="{{ name }}_yn" value="No" required {% if fields and fields[name + '_yn']=='No' %}checked{% endif %}> No</label>
            <label><input type="radio" name="{{ name }}_yn" value="N/A" required {% if fields and fields[name + '_yn']=='N/A' %}checked{% endif %}> N/A</label>
        {% endif %}
    </div>
    <div class="question-comments">
        {% call show_value(name + '_comments') %}
        <textarea name="{{ name }}_comments" placeholder="Comments{{ ' - ' + comment_hint if comment_hint else '' }}" rows="3" style="width: 100%; resize: vertical;"></textarea>
        {% endcall %}
    </div>
</div>
{% endfor %}

<div class="section-title">Project Scope</div>
{% set project_scope_questions = [
    ('Deliverables from MDC required/available?', 'deliverables_mdc', ''),
    ('Several units in the project? Divider Beam, Separator or Screen Considered. Balustrade height?', 'several_units', 'No of units... Configured?...'),
    ('New hoistway light required?', 'new_hoistway_light', ''),
    ('Metal works considered? Hoist Beam, Ladders etc.', 'metal_works', ''),
    ('If VF drive is PF1, RCCB Type budgeted?', 'vf_drive_pf1', ''),
    ('Painting works considered?', 'painting_works', ''),
    ('Electrical works considered?', 'electrical_works', ''),
    ('Civil works considered? Grouting, Fire Sealant', 'civil_works', ''),
    ('Full Shaft Separator Mesh required?', 'full_shaft_separator', ''),
    ('Glass elevator use checklist MAN-0213', 'glass_elevator_checklist', ''),
    ('3 way Intercom considered?', 'intercom', ''),
    ('GI trunking required?', 'gi_trunking', ''),
    ('Dismantling considered?', 'dismantling', ''),
    ('Handover dismantled material to customer?', 'handover_dismantled_material', ''),
    ('SAIS Package: Cwt screen, Machine/rotating equipment guard/Dividing screen/Pit ladder/platform/Shaft lighting 200 lux', 'sais_package', ''),
    ('Safety package: Hook certification/hoarding around landing doors/Finishes: Car lighting lux, Architraves or around landing doors, addl cwt fillers blocks.', 'safety_package', ''),
] %}
{% for label, name, comment_hint in project_scope_questions %}
<div class="question-row">
    <div class="question-label">{{ label }}</div>
    <div class="question-options">
        {% if pdf_mode %}
            <span style="font-weight:normal;">{{ fields[name + '_yn'] if fields and (name + '_yn') in fields else 'N/A' }}</span>
        {% else %}
            <label><input type="radio" name="{{ name }}_yn" value="Yes" required {% if fields and fields[name + '_yn']=='Yes' %}checked{% endif %}> Yes</label>
            <label><input type="radio" name="{{ name }}_yn" value="No" required {% if fields and fields[name + '_yn']=='No' %}checked{% endif %}> No</label>
            <label><input type="radio" name="{{ name }}_yn" value="N/A" required {% if fields and fields[name + '_yn']=='N/A' %}checked{% endif %}> N/A</label>
        {% endif %}
    </div>
    <div class="question-comments">
        {% call show_value(name + '_comments') %}
        <textarea name="{{ name }}_comments" placeholder="Comments{{ ' - ' + comment_hint if comment_hint else '' }}" rows="3" style="width: 100%; resize: vertical;"></textarea>
        {% endcall %}
    </div>
</div>
{% endfor %}

<div class="section-title">Site Survey/IFC</div>
{% set site_survey_questions = [
    ('Incase of Accessible rooms beneath the hoistway, Cwt Safety Gear Included?', 'accessible_rooms_hoistway', ''),
    ('Additional fall protection required? (Landing doors / balustrade / trap doors / fix point for safety equipment, ...)', 'additional_fall_protection', ''),
    ('Building Tolerance considered as minimum +/-25mm?', 'building_tolerance', ''),
    ('Sufficient parking space provided nearby?', 'parking_space', ''),
    ('Building accessible (distance to unloading, stairs, MR access, 2.5m rails, ...)?', 'building_accessible', ''),
    ('Does the Power supply meet schindler requirement?', 'power_supply_schindler', ''),
    ('Does the flooring need special protection?', 'flooring_protection', ''),
    ('Keys required to access the building?', 'keys_required', '')
] %}
{% for label, name, comment_hint in site_survey_questions %}
<div class="question-row">
    <div class="question-label">{{ label }}</div>
    <div class="question-options">
        {% if pdf_mode %}
            <span style="font-weight:normal;">{{ fields[name + '_yn'] if fields and (name + '_yn') in fields else 'N/A' }}</span>
        {% else %}
            <label><input type="radio" name="{{ name }}_yn" value="Yes" required {% if fields and fields[name + '_yn']=='Yes' %}checked{% endif %}> Yes</label>
            <label><input type="radio" name="{{ name }}_yn" value="No" required {% if fields and fields[name + '_yn']=='No' %}checked{% endif %}> No</label>
            <label><input type="radio" name="{{ name }}_yn" value="N/A" required {% if fields and fields[name + '_yn']=='N/A' %}checked{% endif %}> N/A</label>
        {% endif %}
    </div>
    <div class="question-comments">
        {% call show_value(name + '_comments') %}
        <textarea name="{{ name }}_comments" placeholder="Comments{{ ' - ' + comment_hint if comment_hint else '' }}" rows="3" style="width: 100%; resize: vertical;"></textarea>
        {% endcall %}
    </div>
</div>
{% endfor %}

<div class="section-title">Installation Requirements</div>
{% set installation_questions = [
    ('Installation method clear (INEX, scaffold, scaffoldless) Priced Accordingly?', 'installation_method', 'Single or 2/3 stage installation?...'),
    ('Structural building issues?', 'structural_building_issues', ''),
    ('Installation target hours correct, Local Installation Hours considered?', 'installation_target_hours', ''),
    ('Permanent lifting points for installation required and considered?', 'permanent_lifting_points', ''),
    ('Potential equalization existing?', 'potential_equalization', ''),
    ('Sufficient power supply provided?', 'sufficient_power_supply', ''),
    ('Sufficient venting of the hoistway and machine room existing?', 'sufficient_venting', ''),
    ('In case of chemical bolts: Are additional hours considered and charged to the customer?', 'chemical_bolts', ''),
    ('Storage room sufficient?', 'storage_room', ''),
    ('Truck unloading clarified (truck w/ crane required, forklift accessibility, crane cost, ...)?', 'truck_unloading', ''),
    ('Waste disposal site cleaning covered?', 'waste_disposal', ''),
    ('Met SMRA/USANADA Compliance? Necessary equipments priced to make CCTV operational?', 'smra_usanada_compliance', ''),
    ('Alternate fire recall considered?', 'alternate_fire_recall', ''),
    ('Transom Provided?', 'transom_provided', '')
] %}
{% for label, name, comment_hint in installation_questions %}
<div class="question-row">
    <div class="question-label">{{ label }}</div>
    <div class="question-options">
        {% if pdf_mode %}
            <span style="font-weight:normal;">{{ fields[name + '_yn'] if fields and (name + '_yn') in fields else 'N/A' }}</span>
        {% else %}
            <label><input type="radio" name="{{ name }}_yn" value="Yes" required {% if fields and fields[name + '_yn']=='Yes' %}checked{% endif %}> Yes</label>
            <label><input type="radio" name="{{ name }}_yn" value="No" required {% if fields and fields[name + '_yn']=='No' %}checked{% endif %}> No</label>
            <label><input type="radio" name="{{ name }}_yn" value="N/A" required {% if fields and fields[name + '_yn']=='N/A' %}checked{% endif %}> N/A</label>
        {% endif %}
    </div>
    <div class="question-comments">
        {% call show_value(name + '_comments') %}
        <textarea name="{{ name }}_comments" placeholder="Comments{{ ' - ' + comment_hint if comment_hint else '' }}" rows="3" style="width: 100%; resize: vertical;"></textarea>
        {% endcall %}
    </div>
</div>
{% endfor %}

<div class="section-title">Financial & Contract Requirements</div>
{% set financial_questions = [
    ('Is this project a Turnkey?', 'turnkey', 'If Yes, ask for Subcon site check list/compliance'),
    ('Penalty agreed?', 'penalty_agreed', '...per day')
] %}
{% for label, name, comment_hint in financial_questions %}
<div class="question-row">
    <div class="question-label">{{ label }}</div>
    <div class="question-options">
        {% if pdf_mode %}
            <span style="font-weight:normal;">{{ fields[name + '_yn'] if fields and (name + '_yn') in fields else 'N/A' }}</span>
        {% else %}
            <label><input type="radio" name="{{ name }}_yn" value="Yes" required {% if fields and fields[name + '_yn']=='Yes' %}checked{% endif %}> Yes</label>
            <label><input type="radio" name="{{ name }}_yn" value="No" required {% if fields and fields[name + '_yn']=='No' %}checked{% endif %}> No</label>
            <label><input type="radio" name="{{ name }}_yn" value="N/A" required {% if fields and fields[name + '_yn']=='N/A' %}checked{% endif %}> N/A</label>
        {% endif %}
    </div>
    <div class="question-comments">
        {% call show_value(name + '_comments') %}
        <textarea name="{{ name }}_comments" placeholder="Comments{{ ' - ' + comment_hint if comment_hint else '' }}" rows="3" style="width: 100%; resize: vertical;"></textarea>
        {% endcall %}
    </div>
</div>
{% endfor %}

<div class="section-title">Code Requirements</div>
{% set code_questions = [
    ('Special code requirements (Seismic, fire rating, fire fighter, IP rating, local code, vandal proof, disability, ...)?', 'special_code_requirements', ''),
    ('Seismic completed?', 'seismic_completed', 'Zone ...'),
    ('Foreign installation in MR or hoistway? Mitigation?', 'foreign_installation', '')
] %}
{% for label, name, comment_hint in code_questions %}
<div class="question-row">
    <div class="question-label">{{ label }}</div>
    <div class="question-options">
        {% if pdf_mode %}
            <span style="font-weight:normal;">{{ fields[name + '_yn'] if fields and (name + '_yn') in fields else 'N/A' }}</span>
        {% else %}
            <label><input type="radio" name="{{ name }}_yn" value="Yes" required {% if fields and fields[name + '_yn']=='Yes' %}checked{% endif %}> Yes</label>
            <label><input type="radio" name="{{ name }}_yn" value="No" required {% if fields and fields[name + '_yn']=='No' %}checked{% endif %}> No</label>
            <label><input type="radio" name="{{ name }}_yn" value="N/A" required {% if fields and fields[name + '_yn']=='N/A' %}checked{% endif %}> N/A</label>
        {% endif %}
    </div>
    <div class="question-comments">
        {% call show_value(name + '_comments') %}
        <textarea name="{{ name }}_comments" placeholder="Comments{{ ' - ' + comment_hint if comment_hint else '' }}" rows="3" style="width: 100%; resize: vertical;"></textarea>
        {% endcall %}
    </div>
</div>
{% endfor %}

<!-- Signatures Section (Professional Table Layout) -->
<div class="signature-section-table" id="signature-section-table">
    <div class="signature-table-header">Signatures</div>
    <div class="signature-table-row signature-table-review">
        <div class="signature-table-cell" colspan="4" style="font-weight:normal;">I have carefully reviewed and agreed on the project content.</div>
    </div>
    <div class="signature-table-row signature-table-note">
        <div class="signature-table-cell signature-table-note-cell" colspan="4" style="font-size:13px; color:#444;">
            *Projects priced more than one million SAR or projected located in remote areas or for the nonstandard jobs (Specification received from the customer) or CUST product lines or all MOD
        </div>
    </div>
    <div class="signature-table-row signature-table-header-row">
        <div class="signature-table-cell"></div>
        <div class="signature-table-cell">Salesman</div>
        <div class="signature-table-cell">Order engineering</div>
        <div class="signature-table-cell">Project Engineer/Manager</div>
    </div>
    <div class="signature-table-row signature-table-subheader">
        <div class="signature-table-cell" colspan="4" style="font-weight:bold; background:#f8f9fa;">Offer Review</div>
    </div>
    <div class="signature-table-row">
        <div class="signature-table-cell">Name:</div>
        <div class="signature-table-cell">{% call show_value('offer_salesman_name') %}<input type="text" name="offer_salesman_name" class="signature-input">{% endcall %}</div>
        <div class="signature-table-cell">{% call show_value('offer_order_engineering_name') %}<input type="text" name="offer_order_engineering_name" class="signature-input">{% endcall %}</div>
        <div class="signature-table-cell">{% call show_value('offer_manager_name') %}<input type="text" name="offer_manager_name" class="signature-input">{% endcall %}</div>
    </div>
    <div class="signature-table-row">
        <div class="signature-table-cell">Date:</div>
        <div class="signature-table-cell">{% call show_value('offer_salesman_date') %}<input type="date" name="offer_salesman_date" class="signature-input">{% endcall %}</div>
        <div class="signature-table-cell">{% call show_value('offer_order_engineering_date') %}<input type="date" name="offer_order_engineering_date" class="signature-input">{% endcall %}</div>
        <div class="signature-table-cell">{% call show_value('offer_manager_date') %}<input type="date" name="offer_manager_date" class="signature-input">{% endcall %}</div>
    </div>
    <div class="signature-table-row signature-table-subheader">
        <div class="signature-table-cell" colspan="4" style="font-weight:bold; background:#f8f9fa;">Order Review(Pull)</div>
    </div>
    <div class="signature-table-row">
        <div class="signature-table-cell">Name:</div>
        <div class="signature-table-cell">{% call show_value('order_salesman_name') %}<input type="text" name="order_salesman_name" class="signature-input">{% endcall %}</div>
        <div class="signature-table-cell">{% call show_value('order_order_engineering_name') %}<input type="text" name="order_order_engineering_name" class="signature-input">{% endcall %}</div>
        <div class="signature-table-cell">{% call show_value('order_manager_name') %}<input type="text" name="order_manager_name" class="signature-input">{% endcall %}</div>
    </div>
    <div class="signature-table-row">
        <div class="signature-table-cell">Date:</div>
        <div class="signature-table-cell">{% call show_value('order_salesman_date') %}<input type="date" name="order_salesman_date" class="signature-input">{% endcall %}</div>
        <div class="signature-table-cell">{% call show_value('order_order_engineering_date') %}<input type="date" name="order_order_engineering_date" class="signature-input">{% endcall %}</div>
        <div class="signature-table-cell">{% call show_value('order_manager_date') %}<input type="date" name="order_manager_date" class="signature-input">{% endcall %}</div>
    </div>
    <div class="signature-table-row signature-table-remarks">
        <div class="signature-table-cell" colspan="4" style="font-weight:bold; background:#f8f9fa;">Remarks and open items:</div>
    </div>
    <div class="signature-table-row">
        <div class="signature-table-cell" colspan="4">{% call show_value('signature_remarks') %}<textarea name="signature_remarks" class="signature-remarks-textarea"></textarea>{% endcall %}</div>
</div>
    <button type="button" class="signature-doodle-btn" onclick="activateSignatureDoodle(event)">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M2 17.25V21h3.75l11.06-11.06-3.75-3.75L2 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z" fill="#b00"/></svg>
        <span style="font-size:14px; color:#b00; margin-left:6px;">Sign</span>
    </button>
    <input type="hidden" name="signature_doodle_data" id="signature-doodle-data">
    
    <!-- Debug: Check signature data in PDF mode -->
    {% if pdf_mode %}
    <!-- PDF Debug: Signature data length = {{ signature_doodle_data|length if signature_doodle_data else 0 }} -->
    {% endif %}
    
    <!-- Display doodle signature as overlay on signature section -->
    {% if signature_doodle_data %}
        {% if pdf_mode %}
        <!-- For PDF: display as positioned image within signature section -->
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; z-index: 10; margin: 0; padding: 0; border-radius: 8px;">
            <img src="{{ signature_doodle_data }}" alt="Signature" style="width: 100%; height: 100%; object-fit: cover; display: block; margin: 0; padding: 0; border-radius: 8px;">
        </div>
        {% else %}
        <!-- For form view: display as overlay -->
        <div class="signature-doodle-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none;">
            <img src="{{ signature_doodle_data }}" alt="Signature" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.8;">
        </div>
        {% endif %}
    {% endif %}
</div>

<!-- PDF Signature Display Section -->
{% if pdf_mode %}
<div style="margin-top: 30px; border: 2px solid #dadce0; border-radius: 8px; padding: 20px; background: #f8f9fa;">
    <h3 style="margin-top: 0; color: #333; font-size: 18px;">Signatures</h3>
    
    {% if initial_signature %}
    <div style="margin-bottom: 20px;">
        <h4 style="color: #666; font-size: 16px; margin-bottom: 10px;">Initial Submission Signature:</h4>
        <img src="{{ initial_signature }}" alt="Initial Signature" style="max-width: 100%; width: 400px; border: 1px solid #888; border-radius: 6px; background: white;">
    </div>
    {% endif %}
    
    {% if review_signature %}
    <div style="margin-bottom: 20px;">
        <h4 style="color: #666; font-size: 16px; margin-bottom: 10px;">Review Signature:</h4>
        <img src="{{ review_signature }}" alt="Review Signature" style="max-width: 100%; width: 400px; border: 1px solid #888; border-radius: 6px; background: white;">
    </div>
    {% endif %}
    
    {% if approved %}
    <div style="margin-top: 20px; padding: 10px; background: #28a745; color: white; border-radius: 6px; text-align: center; font-weight: bold;">
        ✓ FORM APPROVED BY PROJECT MANAGER
    </div>
    {% endif %}
</div>
{% endif %}

<style>
.signature-section-table {
    margin-top: 40px;
    border: 2px solid #dadce0;
    border-radius: 8px;
    background: #fff;
    padding: 0;
    position: relative;
    overflow: visible;
    font-family: 'Roboto', Arial, sans-serif;
    max-width: 100%;
    min-width: 320px;
    width: 100%;
}
.signature-table-header {
    background: #888;
    color: #fff;
    font-weight: bold;
    font-size: 17px;
    padding: 6px 12px;
    border-top-left-radius: 6px;
    border-top-right-radius: 6px;
}
.signature-table-row {
    display: flex;
    border-bottom: 1px solid #dadce0;
}
.signature-table-cell {
    flex: 1;
    padding: 8px 10px;
    border-right: 1px solid #dadce0;
    font-size: 15px;
    background: #fff;
    min-width: 0;
    display: flex;
    align-items: center;
}
.signature-table-cell:last-child {
    border-right: none;
}
.signature-table-header-row .signature-table-cell {
    background: #f8f9fa;
    font-weight: bold;
    color: #222;
    text-align: center;
}
.signature-table-subheader .signature-table-cell {
    background: #f8f9fa;
    font-weight: bold;
    color: #222;
    border-right: none;
}
.signature-table-note-cell {
    font-size: 13px;
    color: #444;
    background: #f8f9fa;
    border-right: none;
}
.signature-input {
    width: 95%;
    padding: 4px 8px;
    font-size: 15px;
    border: 1px solid #dadce0;
    border-radius: 4px;
    background: #f8f9fa;
}
.signature-remarks-textarea {
    width: 99%;
    min-height: 36px;
    font-size: 15px;
    border: 1px solid #dadce0;
    border-radius: 4px;
    background: #f8f9fa;
    resize: vertical;
}
.signature-doodle-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 12px auto 8px auto;
    background: #fff;
    border: 1.5px solid #b00;
    color: #b00;
    border-radius: 6px;
    padding: 6px 18px;
    font-size: 15px;
    cursor: pointer;
    transition: background 0.2s, border 0.2s;
    position: relative;
    z-index: 11;
    justify-content: center;
}
.signature-doodle-btn:hover {
    background: #f8f9fa;
    border-color: #a00;
}
.signature-doodle-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    width: 100%;
    height: 100%;
    z-index: 20;
    pointer-events: none;
}
.signature-doodle-overlay.active {
    pointer-events: auto;
    cursor: crosshair;
}
@media (max-width: 900px) {
    .signature-section-table, #signature-doodle-canvas {
        max-width: 99vw;
        min-width: 220px;
    }
}
</style>
<script>
function activateSignatureDoodle(e) {
    e.preventDefault();
    const section = document.getElementById('signature-section-table');
    let canvas = document.getElementById('signature-doodle-overlay');
    if (!canvas) {
        canvas = document.createElement('canvas');
        canvas.id = 'signature-doodle-overlay';
        canvas.className = 'signature-doodle-overlay active';
        section.appendChild(canvas);
    }
    // Set canvas size to match section
    canvas.width = section.offsetWidth;
    canvas.height = section.offsetHeight;
    canvas.classList.add('active');
    let ctx = canvas.getContext('2d');
    let drawing = false;
    let lastX = 0, lastY = 0;
    canvas.onmousedown = function(ev) {
        drawing = true;
        [lastX, lastY] = [ev.offsetX, ev.offsetY];
    };
    canvas.onmousemove = function(ev) {
        if (!drawing) return;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(ev.offsetX, ev.offsetY);
        ctx.strokeStyle = '#222';
        ctx.lineWidth = 2;
        ctx.stroke();
        [lastX, lastY] = [ev.offsetX, ev.offsetY];
    };
    canvas.onmouseup = function() { drawing = false; };
    canvas.onmouseout = function() { drawing = false; };
    // Touch support
    canvas.ontouchstart = function(ev) {
        drawing = true;
        let rect = canvas.getBoundingClientRect();
        lastX = ev.touches[0].clientX - rect.left;
        lastY = ev.touches[0].clientY - rect.top;
    };
    canvas.ontouchmove = function(ev) {
        if (!drawing) return;
        let rect = canvas.getBoundingClientRect();
        let x = ev.touches[0].clientX - rect.left;
        let y = ev.touches[0].clientY - rect.top;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#222';
        ctx.lineWidth = 2;
        ctx.stroke();
        lastX = x;
        lastY = y;
        ev.preventDefault();
    };
    canvas.ontouchend = function() { drawing = false; };
    // Save doodle on form submit
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function() {
            document.getElementById('signature-doodle-data').value = canvas.toDataURL();
        });
    }
    // Hide overlay on click outside
    document.addEventListener('mousedown', function handler(ev) {
        if (!canvas.contains(ev.target) && ev.target.className !== 'signature-doodle-btn') {
            canvas.classList.remove('active');
            document.removeEventListener('mousedown', handler);
        }
    });
}
</script> 